name: Deploy Frontend Bida

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT }}
          script: |
            # 1. Đi vào thư mục chứa code nguồn
            cd ${{ secrets.TARGET_DIR }}

            # 2. Cấu hình để tránh lỗi Git ownership
            git config --global --add safe.directory ${{ secrets.TARGET_DIR }}

            # 3. Lấy code mới nhất từ GitHub về
            git fetch --all
            git reset --hard origin/main

            # 4. Cài đặt thư viện và Build (Tạo ra thư mục dist)
            npm install
            npm run build

            # 5. ĐƯA CODE VÀO SỬ DỤNG (Đây là bước bạn đang thiếu)
            # Lệnh này copy mọi thứ TRONG thư mục dist vào thư mục chạy web của bạn
            # -a: giữ nguyên thuộc tính file, -v: hiển thị tiến trình, --delete: xóa file cũ không còn tồn tại trong bản build mới
            rsync -av --delete dist/ /home/bida.uynghi.com/public_html/frontend/

            # 6. Làm mới Nginx để nhận diện nếu có thay đổi cấu hình (không bắt buộc nhưng nên làm)
            sudo systemctl reload nginx

            echo "✅ Đã cập nhật giao diện mới tại bida.uynghi.com"
